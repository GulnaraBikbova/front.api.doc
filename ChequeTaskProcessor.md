---
title: Расширение функционала фискального регистратора 
layout: default
---
# Расширение функционала фискального регистратора #

## Введение
 
Команды фискального регистратора могут быть дополнены любыми другими операциями. 
Например, если нужно сделать предварительные работы перед закрытием заказа или выполнить операции после закрытия заказа.
Схематично, это можно представить так:

![DoCheque](../../img/chequeTaskProcessor/doCheque.png)

Чтобы уметь вклиниваться в процесс закрытия заказа, а также в процессы внесения, изъятия, печать X и Z отчетов, достаточно реализовать интерфейс [`IChequeTaskProcessor`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor.htm) и зарегистрировать его посредством вызова метода API [`RegisterChequeTaskProcessor()`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_IOperationService_RegisterChequeTaskProcessor.htm):
```cs
var chequeTaskProcessor = new ChequeTaskProcessor()
PluginContext.Operations.RegisterChequeTaskProcessor(chequeTaskProcessor);
```

Все команды интерфейса [`IChequeTaskProcessor`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor.htm) могут прервать выполнение основной операции: фискализация чека, внесение, изъятие, печать X и Z отчета. Для этого в теле команды нужно бросить любого вида исключение.
Например, сделаем условие - нельзя закрывать заказы на виртуальном фискальном регистраторе (ФР):
```cs
public void BeforeDoCheckAction(ChequeTask chequeTask, ICashRegisterInfo device, CashRegisterChequeExtensions chequeExtensions, IViewManager viewManager)
{
	// Для примера: разрешать закрывать заказ только на реальном устройстве.
	if (device.IsVirtual)
		throw new Exception("Cash register is virtual. Please close order only on real device.");

	PluginContext.Log.InfoFormat("Before do cheque on cash register: {0} ({1})", device.FriendlyName, device.Id);
}
```
Тогда при закрытии заказа на виртуальном ФР iikoFront выведет сообщение об ошибке и заказ останется открытым:

![BeforeDoChequeException](../../img/chequeTaskProcessor/beforeDoChequeException.png)

Пример реализации интерфейса [`IChequeTaskProcessor`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor.htm) и его регистрация есть в проекте SDK SamplePlugin.


## Интерфейс [`IChequeTaskProcessor`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor.htm)

Рассмотрим подробнее команды [`IChequeTaskProcessor`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor.htm).


### 1. [`BeforeDoCheckAction`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_BeforeDoCheckAction.htm)

[`BeforeDoCheckAction()`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_BeforeDoCheckAction.htm) - команда, которая выполняется перед операцией фискализации чека. Это может быть закрытие заказа, возврат заказа, пречек, отмена пречека. 
Основное ее назначение - проверить возможность выполнения операции, а также добавить в чек дополнительную информацию.

##### Как добавить в чек дополнительную информацию?

Есть 2 способа добавить в чек дополнительную информацию:
- Путем добавления шаблона чека «Дополнение к фискальному чеку»: *iikoOffice => «Администрирование» => «Шаблоны чеков» => «Добавить» => «Тип: Дополнение к фискальному чеку»*.
Написанный здесь шаблон будет добавлен в конец чека [`chequeTask.TextAfterCheque`](http://iiko.github.io/front.api.sdk/v6/html/P_Resto_Front_Api_V6_Data_Device_Tasks_BillTask_TextAfterCheque.htm).

![AddChequeExtensionsIikoOffice](../../img/chequeTaskProcessor/addChequeExtensionsIikoOffice.png)

-  Плагин может сам заполнить поля [`chequeExtensions.BeforeCheque`](http://iiko.github.io/front.api.sdk/v6/html/P_Resto_Front_Api_V6_Data_Device_CashRegisterChequeExtensions_BeforeCheque.htm) и [`chequeExtensions.AfterCheque`](http://iiko.github.io/front.api.sdk/v6/html/P_Resto_Front_Api_V6_Data_Device_CashRegisterChequeExtensions_AfterCheque.htm), используя свой аргумент [`chequeExtensions`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Data_Device_CashRegisterChequeExtensions.htm). 
Эти данные будут перезаписаны в [`chequeTask.TextBeforeCheque`](http://iiko.github.io/front.api.sdk/v6/html/P_Resto_Front_Api_V6_Data_Device_Tasks_BillTask_TextBeforeCheque.htm), [`chequeTask.TextAfterCheque`](http://iiko.github.io/front.api.sdk/v6/html/P_Resto_Front_Api_V6_Data_Device_Tasks_BillTask_TextAfterCheque.htm) соответственно и переданы в ФР для печати.
```cs
public void BeforeDoCheckAction(ChequeTask chequeTask, ICashRegisterInfo device, CashRegisterChequeExtensions chequeExtensions, IViewManager viewManager)
{
		...
		chequeExtensions.BeforeCheque.Add(new Center(new XElement("Начало")));
		chequeExtensions.AfterCheque.Add(new Center(new XElement("Конец")));
		...
}
```

Аргументы функции [`BeforeDoCheckAction()`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_BeforeDoCheckAction.htm):
- [`chequeTask`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Data_Device_Tasks_ChequeTask.htm) — *информация по заказу*. 
Вся информация по позициям  заказа, скидкам/надбавкам, оплатах и прочее (см. статью [*API внешние фискальные регистраторы*](CashRegisters.html "Внешние фискальные регистраторы")).
- [`device`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Data_Device_ICashRegisterInfo.htm) — *информация по фискальному регистратору, на котором происходит закрытие заказа*.
- [`chequeExtensions`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Data_Device_CashRegisterChequeExtensions.htm) - *дополнительныя информация по чеку*. 
Хранит разметки для добавления их в начало и конец чека ([`chequeExtensions.BeforeCheque`](http://iiko.github.io/front.api.sdk/v6/html/P_Resto_Front_Api_V6_Data_Device_CashRegisterChequeExtensions_BeforeCheque.htm), [`chequeExtensions.AfterCheque`](http://iiko.github.io/front.api.sdk/v6/html/P_Resto_Front_Api_V6_Data_Device_CashRegisterChequeExtensions_AfterCheque.htm)).
Также хранит идентификатор [`chequeExtensions.PastOrderId`](http://iiko.github.io/front.api.sdk/v6/html/P_Resto_Front_Api_V6_Data_Device_CashRegisterChequeExtensions_PastOrderId.htm) и номер [`chequeExtensions.PastOrderNumber`](http://iiko.github.io/front.api.sdk/v6/html/P_Resto_Front_Api_V6_Data_Device_CashRegisterChequeExtensions_PastOrderNumber.htm) заказа, закрытого в прошлой КС.
Эти поля заполняются при возврате заказа из прошлой КС.
- [`viewManager`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_UI_IViewManager.htm) — *диалоговое окно*.
Позволяет показывать предопределённый набор встроенных в iikoFront диалоговых окон (см. статью [*API диалоговые окна*](ViewManager.html "Диалоговые окна")).


### 2. [`AfterDoCheckAction`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_AfterDoCheckAction.htm)

[`AfterDoCheckAction()`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_AfterDoCheckAction.htm) - команда, которая выполняется после операции фискализации чека. 
Основное ее назначение - выполнить завершающие действия после печати чека, например, добавить в очередь операцию выгрузки во внешнюю систему.
Аргумент [`result`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Data_Device_Results_PostResult.htm) описывает результат выполнения операции на ФР. 
[`result.Success = true`](http://iiko.github.io/front.api.sdk/v6/html/P_Resto_Front_Api_V6_Data_Device_Results_PostResult_Success.htm) - операция выполнена успешно, иначе - неуспех.
Если операция выполнена неуспешно [`PostResult.Success = false`](http://iiko.github.io/front.api.sdk/v6/html/P_Resto_Front_Api_V6_Data_Device_Results_PostResult_Success.htm), текст ошибки можно будет увидеть в [`result.Message`](http://iiko.github.io/front.api.sdk/v6/html/P_Resto_Front_Api_V6_Data_Device_Results_PostResult_Message.htm).


### 3. [`BeforeXReport`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_BeforeXReport.htm)

[`BeforeXReport()`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_BeforeXReport.htm) - команда, которая выполняется перед печатью X-отчета.
В качестве параметров также передаются фискальный регистратор, на котором проводится операция, диалоговое окно для показа сообщений или ввода данных и пользователь [`authUser`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Data_Security_IUser.htm), инициирующий печать X-отчета. 


### 4. [`AfterXReport`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_AfterXReport.htm)

[`AfterXReport()`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_AfterXReport.htm) - команда, которая выполняется после печати X-отчета.
Аргументы аналогичны команде [`AfterDoCheckAction`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_AfterDoCheckAction.htm).


### 5. [`BeforeZReport`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_BeforeZReport.htm)

[`BeforeZReport`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_BeforeZReport.htm) - команда, которая выполняется перед печатью Z-отчета.
Параметрами передаются: ФР, пользователь и диалоговое окно.


### 6. [`AfterPayIn`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_AfterPayIn.htm)

[`AfterPayIn`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_AfterPayIn.htm) - команда, которая выполняется после внесения денежный средств в кассу.
В функцию передаются: ФР, ответ фискального регистратора при выполнении внесения, диалоговое окно и сумма денежных средств, которую вносили в кассу.


### 7. [`AfterPayOut`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_AfterPayOut.htm)

[`AfterPayOut`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor_AfterPayOut.htm) - команда, которая выполняется после изъятия денежных средств из кассы.
В функцию передаются: ФР, ответ фискального регистратора при выполнении изъятия, диалоговое окно и сумма денежных средств, которую изымали из кассы.


### Дополнительные интерфейсы [`IReadonlyChequeTaskProcessor`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IReadonlyChequeTaskProcessor.htm) и [`IEditableChequeTaskProcessor`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IEditableChequeTaskProcessor.htm)

Наряду с вышеописанным интерфейсом [`IChequeTaskProcessor`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IChequeTaskProcessor.htm), также есть расширяющие его интерфейсы [`IReadonlyChequeTaskProcessor`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IReadonlyChequeTaskProcessor.htm) и [`IEditableChequeTaskProcessor`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IEditableChequeTaskProcessor.htm), которые позволяют выполнять свои задачи перед выполнением внесения и изъятия на кассе.


Регистрируются они точно также, как родительский интерфейс.
Разница между ними лишь в том, что используя интерфейс [`IReadonlyChequeTaskProcessor`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IReadonlyChequeTaskProcessor.htm) плагин при изъятии денежных средств не может отредактировать сумму изъятия, а используя интерфейс [`IEditableChequeTaskProcessor`](http://iiko.github.io/front.api.sdk/v6/html/T_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IEditableChequeTaskProcessor.htm) - может, за счет параметра [`ref estimatedSum`](http://iiko.github.io/front.api.sdk/v6/html/M_Resto_Front_Api_V6_Devices_ChequeTaskProcessor_IEditableChequeTaskProcessor_BeforePayOutSessionClosed.htm).
Это сделано для того, чтобы при закрытии КС плагин мог регулировать сумму изъятия.